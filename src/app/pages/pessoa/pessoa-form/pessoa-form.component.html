<div class="page-wrapper">
  <div class="scroll-area">
    <div class="card-form shadow p-4 rounded mx-auto mt-3" style="max-width: 90%;">

      <!-- T√çTULO -->
      <h4 class="text-center mb-4 fw-semibold">
        üë§ {{ isEdit ? 'Editar Pessoa' : 'Nova Pessoa' }}
      </h4>

      <!-- NAV TABS -->
      <ul class="nav nav-tabs pessoa-tabs" id="pessoaTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabEdicao" type="button">
            {{ form.get('nomePessoa')?.value || 'Dados da Pessoa' }}
          </button>
        </li>

        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabContatos" type="button">
            CONTATOS
          </button>
        </li>

        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabProdutos" type="button"
            (click)="carregarProdutos()">
            PRODUTOS
          </button>
        </li>
      </ul>



      <div class="tabs-divider"></div> <!-- üî• Divisor abaixo das tabs -->

      <div class="tab-content">

        <!-- ==================================================== -->
        <!-- ABA 1 ‚Äî EDI√á√ÉO DE TODOS OS DADOS DA PESSOA -->
        <!-- ==================================================== -->
        <div class="tab-pane fade show active" id="tabEdicao">
          <form [formGroup]="form" (ngSubmit)="salvar()">

            <!-- DADOS PESSOAIS -->
            <h5 class="fw-semibold mt-3 mb-3">Dados Pessoais</h5>

            <div class="row g-3 mb-3">
              <div class="col-md-3">
                <label class="form-label">Tipo de Pessoa</label>
                <select class="form-control" formControlName="tipoPessoa">
                  <option value="F">Pessoa F√≠sica</option>
                  <option value="J">Pessoa Jur√≠dica</option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">
                  {{ form.get('tipoPessoa')?.value === 'F' ? 'CPF' : 'CNPJ' }}
                </label>
                <input class="form-control" formControlName="documentoPessoa">
              </div>

              <div class="col-md-5">
                <label class="form-label">
                  {{ form.get('tipoPessoa')?.value === 'F' ? 'RG' : 'Inscri√ß√£o Estadual' }}
                </label>
                <input class="form-control" formControlName="identidadePessoa">
              </div>
            </div>

            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label class="form-label">Nome</label>
                <input class="form-control" formControlName="nomePessoa">
              </div>

              <div class="col-md-6">
                <label class="form-label">Apelido</label>
                <input class="form-control" formControlName="apelidoPessoa">
              </div>
            </div>

            <!-- ENDERE√áO -->
            <h5 class="fw-semibold mt-4 mb-3">Endere√ßo</h5>

            <div class="row g-3 mb-3">
              <div class="col-md-3">
                <label class="form-label">CEP</label>
                <input class="form-control" formControlName="cepPessoaString" blueprintMask="00000-000"
                  (blur)="buscarCep()">
              </div>

              <div class="col-md-6">
                <label class="form-label">Logradouro</label>
                <input class="form-control" formControlName="logradouroPessoa">
              </div>

              <div class="col-md-3">
                <label class="form-label">N√∫mero</label>
                <input class="form-control" formControlName="numeroPessoa">
              </div>
            </div>

            <div class="row g-3 mb-3">
              <div class="col-md-3">
                <label class="form-label">Complemento</label>
                <input class="form-control" formControlName="complementoPessoa">
              </div>

              <div class="col-md-3">
                <label class="form-label">Bairro</label>
                <input class="form-control" formControlName="bairroPessoa">
              </div>

              <div class="col-md-3">
                <label class="form-label">Estado</label>
                <select class="form-control" formControlName="estado">
                  <option value="">Selecione</option>
                  <option *ngFor="let uf of estados" [value]="uf.idEstado">{{ uf.nomeEstado }}</option>
                </select>
              </div>

              <div class="col-md-3">
                <label class="form-label">Cidade</label>
                <select class="form-control" formControlName="cidade">
                  <option value="">Selecione</option>
                  <option *ngFor="let c of cidades" [value]="c.idCidade">{{ c.nomeCidade }}</option>
                </select>
              </div>
            </div>

            <!-- FINANCEIRO -->
            <h5 class="fw-semibold mt-4 mb-3">Financeiro</h5>

            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label class="form-label">Condi√ß√£o de Pagamento</label>
                <select class="form-control" formControlName="idCondicaoPagamento">
                  <option value="">Selecione</option>
                  <option *ngFor="let cond of condicoesPagamento" [value]="cond.idCondicaoPagamento">
                    {{ cond.descricaoCondicaoPagamento }}
                  </option>
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label">Status</label>
                <select class="form-control" formControlName="status">
                  <option [value]="true">Ativa</option>
                  <option [value]="false">Inativa</option>
                </select>
              </div>
            </div>

            <!-- OBSERVA√á√ÉO -->
            <div class="row mb-3">
              <div class="col-12">
                <label class="form-label">Observa√ß√£o</label>
                <textarea rows="3" class="form-control" formControlName="observacao"></textarea>
              </div>
            </div>

            <!-- BOT√ïES -->
            <div class="d-flex justify-content-center gap-3 mt-4">
              <button type="submit" class="btn btn-primary px-4">
                {{ isEdit ? 'Atualizar' : 'Salvar' }}
              </button>
              <button type="button" class="btn btn-secondary px-4" (click)="cancelar()">
                Cancelar
              </button>
            </div>

          </form>
        </div>

        <!-- ==================================================== -->
        <!-- ABA 3 ‚Äî PRODUTOS -->
        <!-- ==================================================== -->
        <div class="tab-pane fade" id="tabProdutos">
          <div class="d-flex justify-content-end mb-2">
            <button class="btn btn-primary" (click)="novoProduto()">
              <i class="fa fa-plus"></i> Novo Produto
            </button>
          </div>
          <!-- TABELA -->
          <table class="table table-striped table-bordered">
            <thead>
              <tr>
                <th>Seq</th>
                <th>Produto</th>
                <th>Complemento</th>
                <th>UNP</th>
                <th>UNV</th>
                <th class="text-end">Valor</th>
                <th class="text-center">A√ß√µes</th>
              </tr>
            </thead>

            <tbody>
              <tr *ngFor="let produto of produtosPaginados">
                <td>{{ produto.seqProduto }}</td>
                <td>{{ produto.nomeProduto }}</td>
                <td>{{ produto.complementoProduto }}</td>
                <td>{{ produto.unpProduto }}</td>
                <td>{{ produto.unvProduto }}</td>
                <td>{{ produto.valorVenda | currency:'BRL' }}</td>

                <!-- A√á√ïES -->
                <td class="col-acoes">
                  <div class="acoes-wrapper">

                    <button class="btn btn-warning btn-acao" (click)="editarProduto(produto)">
                      <i class="fa fa-pen"></i>
                    </button>

                    <button class="btn btn-info btn-acao" (click)="verHistorico(produto)">
                      <i class="fa fa-clock-rotate-left"></i>
                    </button>

                    <button *ngIf="produto.qtdItens === 0" class="btn btn-danger btn-acao"
                      (click)="deletarProduto(produto)">
                      <i class="fa fa-trash"></i>
                    </button>

                  </div>
                </td>
              </tr>

            </tbody>
          </table>

          <!-- PAGINA√á√ÉO -->
          <div class="d-flex justify-content-between align-items-center mt-2">

            <div class="text-muted">
              Mostrando {{ inicioRegistro }} - {{ fimRegistro }} de {{ totalRegistros }}
            </div>

            <div class="btn-group">
              <button class="btn btn-light" [disabled]="paginaAtual === 1" (click)="paginaAnterior()">
                ‚Äπ Anterior
              </button>

              <button class="btn btn-light" [disabled]="paginaAtual === totalPaginas" (click)="proximaPagina()">
                Pr√≥xima ‚Ä∫
              </button>
            </div>

          </div>

        </div>



        <!-- ==================================================== -->
        <!-- ABA 2 ‚Äî CONTATOS -->
        <!-- ==================================================== -->
        <div class="tab-pane fade" id="tabContatos">

          <div class="d-flex justify-content-end mb-3">
            <button class="btn btn-primary btn-breadcrumb" (click)="novoContato()">
              <i class="fa-solid fa-plus"></i> Adicionar Contato
            </button>
          </div>



          <table class="table table-striped table-bordered">
            <thead>
              <tr>
                <th>Tipo de Contato</th>
                <th>Contato</th>
                <th>Observa√ß√£o</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>

            <tbody>
              <tr *ngFor="let c of contatos">
                <td>{{ c.tipoContato.descricao }}</td>
                <td>{{ c.contato }}</td>
                <td>{{ c.observacao }}</td>
                <td class="col-acoes">
                  <div class="acoes-wrapper">
                    <button class="btn btn-warning btn-acao" (click)="editarContato(c)">
                      <i class="fa fa-pen"></i>
                    </button>

                    <button class="btn btn-danger btn-acao" (click)="deletarContato(c)">
                      <i class="fa fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>

        </div>

      </div>





      <!-- ===================== MODAL CONTATO ===================== -->
      <div class="modal fade" id="modalContato" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">

            <div class="modal-header">
              <h5 class="modal-title">
                {{ contatoEditando ? 'Editar Contato' : 'Novo Contato' }}
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

              <form [formGroup]="formContato">

                <div class="row g-3">

                  <div class="col-md-2">
                    <label class="form-label">Seq</label>
                    <input class="form-control" formControlName="seqContato" readonly>
                  </div>

                  <div class="col-md-4">
                    <label class="form-label">Tipo de Contato</label>
                    <select class="form-control" formControlName="idTipoContato">
                      <option *ngFor="let t of tiposContato" [value]="t.id">
                        {{ t.descricao }}
                      </option>
                    </select>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Contato</label>
                    <input class="form-control" formControlName="contato">
                  </div>

                  <div class="col-md-12">
                    <label class="form-label">Observa√ß√£o</label>
                    <input class="form-control" formControlName="observacao">
                  </div>

                </div>

              </form>

            </div>

            <div class="modal-footer">
              <button class="btn btn-primary" (click)="salvarContato()">
                Salvar
              </button>
              <button class="btn btn-secondary" data-bs-dismiss="modal">
                Cancelar
              </button>
            </div>

          </div>
        </div>
      </div>

      <!-- ===================== MODAL HIST√ìRICO DE PRE√áOS ===================== -->
      <div class="modal fade" id="modalHistoricoProduto" tabindex="-1">
        <div class="modal-dialog modal-md">
          <div class="modal-content">

            <!-- HEADER -->
            <div class="modal-header">
              <h5 class="modal-title">
                Hist√≥rico de Pre√ßos
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <!-- BODY -->
            <div class="modal-body">

              <!-- IDENTIFICA√á√ÉO -->
              <div class="mb-3 text-muted">
                <strong>{{ historicoProdutoSelecionado?.nomeProduto }}</strong>
                <span *ngIf="historicoProdutoSelecionado?.complementoProduto">
                  [{{ historicoProdutoSelecionado?.complementoProduto }}]
                </span>
              </div>

              <!-- TABELA -->
              <table class="table table-sm table-bordered table-striped">
                <thead>
                  <tr>
                    <th>V√°lido At√©</th>
                    <th class="text-end">Valor de Venda</th>
                  </tr>
                </thead>

                <tbody>
                  <tr *ngIf="historicoPrecos.length === 0">
                    <td colspan="2" class="text-center text-muted">
                      Nenhum hist√≥rico encontrado
                    </td>
                  </tr>

                  <tr *ngFor="let h of historicoPrecos">
                    <td class="text-center">
                      {{ h.dtValidade ? (h.dtValidade | date:'dd/MM/yyyy') : 'Atual' }}
                    </td>
                    <td class="text-end">
                      {{ h.valorVenda | currency:'BRL' }}
                    </td>
                  </tr>
                </tbody>
              </table>

            </div>

            <!-- FOOTER -->
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">
                Fechar
              </button>
            </div>

          </div>
        </div>
      </div>

      <!-- ===================== MODAL PRODUTO ===================== -->
      <div class="modal fade" id="modalProduto" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">

            <!-- HEADER -->
            <div class="modal-header">
              <h5 class="modal-title">
                {{ produtoEditando ? 'Editar Produto' : 'Novo Produto' }}
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <!-- BODY -->
            <div class="modal-body">
              <form [formGroup]="formProduto">

                <div class="row g-3">

                  <!-- SEQ -->
                  <div class="col-md-2">
                    <label class="form-label">Seq</label>
                    <input class="form-control" formControlName="seqProduto" readonly>
                  </div>

                  <!-- PRODUTO -->
                  <div class="col-md-6">
                    <label class="form-label">Produto</label>
                    <select class="form-control" formControlName="idProduto">
                      <option [ngValue]="null">Selecione</option>
                      <option *ngFor="let p of produtosCatalogo" [ngValue]="p.idProduto">
                        {{ p.nomeProduto }}
                      </option>
                    </select>
                  </div>





                  <!-- COMPLEMENTO -->
                  <div class="col-md-4">
                    <label class="form-label">Complemento</label>
                    <input class="form-control" formControlName="complementoProduto">
                  </div>

                  <!-- UNP -->
                  <div class="col-md-3">
                    <label class="form-label">UNP</label>
                    <input class="form-control" formControlName="unpProduto">
                  </div>

                  <!-- UNV -->
                  <div class="col-md-3">
                    <label class="form-label">UNV</label>
                    <input class="form-control" formControlName="unvProduto">
                  </div>

                  <!-- VALOR -->
                  <div class="col-md-3">
                    <label class="form-label">Valor Venda</label>
                    <input type="number" step="0.01" class="form-control" formControlName="valorVenda">
                  </div>

                </div>

              </form>
            </div>

            <!-- FOOTER -->
            <div class="modal-footer">
              <button class="btn btn-primary" (click)="salvarProduto()">
                Salvar
              </button>
              <button class="btn btn-secondary" data-bs-dismiss="modal">
                Cancelar
              </button>
            </div>

          </div>
        </div>
      </div>